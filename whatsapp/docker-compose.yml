version: '3.8'

services:
  whatsapp-ces-bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: whatsapp-ces-bot
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      # WhatsApp/Meta Configuration
      - WHATSAPP_ACCESS_TOKEN=${WHATSAPP_ACCESS_TOKEN}
      - WHATSAPP_PHONE_NUMBER_ID=${WHATSAPP_PHONE_NUMBER_ID}
      - WHATSAPP_BUSINESS_ACCOUNT_ID=${WHATSAPP_BUSINESS_ACCOUNT_ID}
      - WHATSAPP_VERIFY_TOKEN=${WHATSAPP_VERIFY_TOKEN}
      - WHATSAPP_API_VERSION=${WHATSAPP_API_VERSION:-v18.0}
      # Google Cloud Configuration
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - GCP_REGION=${GCP_REGION:-us}
      # CX Agent Studio Configuration
      - CES_APP_ID=${CES_APP_ID}
      - CES_DEPLOYMENT_ID=${CES_DEPLOYMENT_ID}
      # Bot Behavior
      - USE_BIDI_SESSION=${USE_BIDI_SESSION:-false}
      # Server Configuration
      - PORT=3000
      - LOG_LEVEL=${LOG_LEVEL:-info}
      # Google credentials (mounted as volume)
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials.json
    volumes:
      # Mount service account credentials
      - ${GOOGLE_APPLICATION_CREDENTIALS:-./service-account-key.json}:/app/credentials.json:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
